configfile: "config/config.yaml"

import pandas as pd

CHROMS = [f"chr{i}" for i in range(1, 23)]
CELL_TYPES = pd.read_csv(config["inputs"]["cell_type_annotations"], sep=",")[config["inputs"]["cell_type_column"]].unique().tolist()

def get_samples_from_bams():
    """Scans the BAM directory and returns unique sample names."""
    import glob
    import os
    bam_dir = config["paths"]["bam_dir"]
    bam_files = glob.glob(os.path.join(bam_dir, "*.bam"))
    if not bam_files:
        raise ValueError(f"No .bam files found in {bam_dir}")
    samples = [os.path.basename(f).replace(".bam", "") for f in bam_files]
    return list(set(samples))

SAMPLES = get_samples_from_bams()
print(f"Identified samples: {SAMPLES}")

rule all:
    input:
        expand("results/genotyped/{sample}_{celltype}_{chrom}.single_cell_genotype.tsv",
               sample=SAMPLES,
               celltype=CELL_TYPES,
               chrom=CHROMS)

include: "rules/split_and_index_bam.smk"
include: "rules/variant_call.smk"
include: "rules/genotype.smk"